#
# Make for TUXEDO server
#
# When make a TUXEDO server, TOOLs MUST generate 2 files:
#   1) build/AGsvr_XXX/tps.mk
#   2) build/AGsvr_XXX/tps.LST
# and copy this template makefile to build/AGsvr_XXX.
# 
# See follow comments for details.
#
# WXQ@XDU 2013.5
#

include ../makefile.appdefs

###########################################################
# PART I: saved in ./tps.mk which generated by TOOLs
#


## artifact NAME
#ART_NAME=SAMP
#
## objects for each trade-entry-function
## the number in file is trade-code
#OBJS = \
#tp1.o \
#tp2.o
#
##
#
## objects for each functional trade
## the number in file is trade-code
#TRDOBJS =\
#td1.o \
#td2.o
#
## search path for source codes of $TARGETS, and
## use space character to separate two path
#VPATH=../AGservices ../../src/??
#
#
## options to compiler for $TARGETS
## -I for header files' search path
## -D for define one MACRO
#MYDEF=
#
## options to linker for $TARGETS
## -L for library search path
## -l for one library to be linked
#MYLIB=


#
# E n d   o f   P A R T   I
###########################################################



include ./tps.mk

# Service list file, generated by TOOLs.
# Each line of this file is treated as an argument to the -s option. 
# You may put comments in this file. All comments must start with 
# the ¡®#¡¯ character. 
# This file can be used to specify all the functions in the server
# that may have services mapped to them. 
SVCLST=tps.LST

# shared object, store all function-type trade
TRDSO=$(ART_NAME)$(DLLEXT)

# artifact dependencies that auto-generated by MAKE
C_DEPS=$(OBJS:.o=.d) $(TRDOBJS:.o=.d)

ifneq ($(MAKECMDGOALS),clean)
ifneq ($(strip $(C_DEPS)),)
-include $(C_DEPS)
endif
endif


# server and its shared objects for its trades
TARGETS=$(APPLIBDIR)/$(TRDSO) $(APPBINDIR)/$(ART_NAME)




all: $(TARGETS)

$(APPBINDIR)/$(ART_NAME): (OBJS) $(APPLIBDIR)/$(TRDSO)
	@$(ECHO) 'Building target: $@'
	CC=$(CC) CFLAGS="${TUXSVR_CFLAG} ${MYLIB}" \
	LD_LIBRARY_PATH="${APPLIBDIR}:${GOLPLIBDIR}:${LD_LIBRARY_PATH}" \
	buildserver -o $@  -A -t -s @$(SVCLST) -f $(TUXBOOT) -f "$(OBJS)" -f $(APPLIBDIR)/$(TRDSO)
	@$(ECHO) 'Finished building target: $@'
	@$(ECHO) ' '

$(APPLIBDIR)/$(TRDSO): $(TRDOBJS)
	@$(ECHO) 'Building target: $@'
	$(LD) -o $@ $(SOFLAG) $(TRDOBJS) ${LIBOPTS} $(MYLIB) 
	@$(ECHO) 'Finished building target: $@'
	@$(ECHO) ' '


%.o: %.cpp
	$(CC) -c -o $@ $(CFLAGS) $(MYDEF) -MMD -MP -MF"$(@:%.o=%.d)" -MT"$(@:%.o=%.d)" $<
	@$(ECHO) ' '

%.o: %.c
	$(CC) -c -o $@ $(CFLAGS) $(MYDEF) -MMD -MP -MF"$(@:%.o=%.d)" -MT"$(@:%.o=%.d)" $<
	@$(ECHO) ' '


clean:
	-$(RM) $(OBJS) $(C_DEPS) $(TRDOBJS) $(TARGETS)
	-@echo ' '

mostlyclean:
	-$(RM) $(OBJS) $(C_DEPS) $(TRDOBJS) 
	-@$(ECHO) ' '

install: $(TARGETS)
	@$(CP) $(APPBINDIR)/$(ART_NAME) $(INSTBINDIR)/
	@$(CP) $(APPLIBDIR)/$(TRDSO)    $(INSTLIBDIR)/
	@$(ECHO) 'The $(ART_NAME) has copied.'
	@$(ECHO) ' '

