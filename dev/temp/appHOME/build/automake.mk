#
# Makefile for all components that auto-generated.
#
#   ONLY for applications based on GOLP 
#
# WXQ@XDU 2013.5
#

include ./makefile.appdefs

#file to dump CC flags for buildserver
CCENVF=ccenv.txt

#
# All components should without path, eg. mys1, mylib1.
# For each component, it should :
#  1) is a server based on TUXEDO+GOLP;
#  2) has 2 files in its directory, one is 'tps.mk' for all objects
#     and options for compiler and linker, another is 'tps.LST' for
#     all serviceName:serviceHandler pairs.
#     Both files are generated by TOOLs.
#
components=
# this file should be created by 'make -f automake.mk genlist'
ARTLST=./components.list
-include $(ARTLST)

.PHONY: clean mostlyclean all compile install genlist usage $(CCENVF)
.DEFAULT_GOAL := usage


usage: 
	@echo
	@echo You should be 'make genlist' first, and then
	@echo 'make all' -- compile all components;
	@echo 'make install' -- install all components to runtime directory;
	@echo 'make clean'   -- remove all object-codes for all components.
	@echo

all compile: $(ARTLST) 
	@for c in $(components); \
	do \
	   $(MAKE) -C $$c $@ ; \
	   if [ $$? -ne 0 ]; then \
		echo ; echo "Make $$c FAILed!";\
	   fi ; \
	done

install: compile
	@for c in $(components); \
	do \
	   $(MAKE) -C $$c --no-print-directory $@ ; \
	   if [ $$? -ne 0 ]; then \
		echo ; echo "Install $$c FAILed!";\
		break; \
	   fi ; \
	done

clean: $(ARTLST)
	@for c in $(components); \
	do \
	   $(MAKE) -C $$c --no-print-directory $@ 2>/dev/null; \
	done

mostlyclean: $(ARTLST)
	@for c in $(components); \
	do \
	   $(MAKE) -C $$c --no-print-directory $@ 2>/dev/null; \
	done

$(ARTLST):
	@$(ECHO) The file 'components.list' SHOULD be created by tools 
	@$(ECHO) "  or generated by 'make genlist -f automake.mk'."
	@$(ECHO)

genlist:
	-@touch $(ARTLST); rm $(ARTLST) 2>/dev/null ; 
	@ls -d AGsvr_* | while read a ;\
	do \
	  if [ -d "$$a" -a -f "$$a/tps.mk" ]; then \
         echo "components+="$$a >>$(ARTLST); \
	     cp $(TEMPLATEDIR)/makefiles/svrMake.mdl $$a/Makefile ; \
	  fi; \
	done
	@if [ -f $(ARTLST) ] ; then \
	   cat $(ARTLST) \
	else \
	   echo "No component found.";\
	fi


$(CCENVF): ./makefile.appdefs
	-@touch $(CCENVF); rm -f $(CCENVF) 2>/dev/null ; 
	@$(ECHO) "TUXDIR="$(TUXDIR) >> $(CCENVF)
	@$(ECHO) "ORACLE_HOME="$(ORACLE_HOME) >> $(CCENVF)
	@$(ECHO) "GOLPHOME="$(GOLPHOME) >> $(CCENVF)
	@$(ECHO) "GOLPAPPHOME="$(APPHOME) >> $(CCENVF)
	@$(ECHO) "BUILDDIR="$(BUILDDIR) >> $(CCENVF)
	@$(ECHO) "TEMPLATEDIR="$(TEMPLATEDIR) >> $(CCENVF)
	@$(ECHO) "LIBOPTS="$(LIBOPTS) >> $(CCENVF)
	@$(ECHO) "CC="$(CC) >> $(CCENVF)
	@$(ECHO) "CFLAGS="$(CFLAGS) >> $(CCENVF)
	@$(ECHO) "LD_LIBRARY_PATH="$(APPLIBDIR):$(GOLPLIBDIR):$(LD_LIBRARY_PATH) >> $(CCENVF)
